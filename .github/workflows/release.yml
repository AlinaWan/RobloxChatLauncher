name: Build & Release Installer

permissions:
  contents: write
  id-token: write # Required for keyless signing

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag for the release (e.g., v1.0.0)"
        required: true
      release_name:
        description: "Name of the release (defaults to the tag)"
        required: false
      prerelease:
        description: "Is this a prerelease?"
        required: false
        default: false
        type: boolean

jobs:
  build-release:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------
      # Normalize tag & update Installer.iss (only if needed)
      # ---------------------------
      - name: Update version in Installer.iss if needed
        working-directory: ./installer
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.tag_name }}"
          if ($tag.StartsWith("v")) { $tag = $tag.Substring(1) }

          $path = "Installer.iss"
          $content = Get-Content $path -Raw

          if ($content -notmatch "^AppVersion=$tag$") {
            Write-Host "Updating AppVersion to $tag"
            $updated = $content -replace '^AppVersion=.*', "AppVersion=$tag"
            Set-Content -Path $path -Value $updated -NoNewline
          } else {
            Write-Host "AppVersion already correct"
          }

      # ---------------------------
      # Setup .NET SDK 10.0
      # ---------------------------
      - name: Setup .NET SDK 10.0.101 # SDK uses a different patch version than runtimes
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.101"

      # ---------------------------
      # Build & validate app
      # ---------------------------
      - name: Restore dependencies
        run: dotnet restore

      - name: Publish app (Release)
        run: dotnet publish -c Release

      # ---------------------------
      # Install Inno Setup
      # ---------------------------
      - name: Download and install Inno Setup 6.4.3
        working-directory: ./installer
        shell: pwsh
        run: |
          Invoke-WebRequest `
            -Uri "https://files.jrsoftware.org/is/6/innosetup-6.4.3.exe" `
            -OutFile is.exe

          Start-Process `
            -FilePath ".\is.exe" `
            -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" `
            -Wait

          Remove-Item .\is.exe

      # ---------------------------
      # Build installer
      # ---------------------------
      - name: Build installer with Inno Setup
        working-directory: ./installer
        shell: cmd
        run: |
          "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" Installer.iss

      # ---------------------------
      # Generate SHA-256
      # ---------------------------
      - name: Generate SHA-256 hash
        working-directory: ./installer
        shell: pwsh
        run: |
          $installer = Get-ChildItem Installer*.exe | Select-Object -First 1
          if (-not $installer) {
            Write-Error "Installer executable not found"
            exit 1
          }

          $hash = Get-FileHash $installer.FullName -Algorithm SHA256 |
            Select-Object -ExpandProperty Hash

          Set-Content -Encoding ASCII -Path Installer.exe.sha256 -Value $hash

      # ---------------------------
      # Sign and attest the installer
      # ---------------------------
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.3.0

      - name: Sign the installer (Blob)
        run: |
          cosign sign-blob ./installer/Installer.exe \
            --bundle ./installer/Installer.exe.cosign.bundle \
            --yes \
            -a repo=${{ github.repository }} \
            -a commit_sha=${{ github.sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------------------------
      # Create GitHub Release
      # ---------------------------
      - name: Create GitHub Release and upload artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          name: ${{ github.event.inputs.release_name || github.event.inputs.tag_name }}
          prerelease: ${{ github.event.inputs.prerelease }}
          generate_release_notes: true
          files: |
            installer/Installer*.exe
            installer/Installer.exe.sha256
            installer/Installer.exe.cosign.bundle
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
