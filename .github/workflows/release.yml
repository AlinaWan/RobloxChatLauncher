name: Build & Release Installer

permissions:
  contents: write
  id-token: write # Required for keyless signing
  attestations: write # Required for GitHub Attestation

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag for the release (e.g., v1.0.0)"
        required: true
      release_name:
        description: "Name of the release (defaults to the tag)"
        required: false
      custom_notes:
        description: "Custom message to include in release notes"
        required: false
        default: ""
      prerelease:
        description: "Is this a prerelease?"
        required: false
        default: false
        type: boolean

jobs:
  build-release:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------
      # Normalize tag & update Installer.iss (only if needed)
      # ---------------------------
      - name: Update version in Installer.iss if needed
        working-directory: ./installer
        shell: pwsh
        run: |
          $tag = "${{ github.event.inputs.tag_name }}"
          if ($tag.StartsWith("v")) { $tag = $tag.Substring(1) }

          $path = "Installer.iss"
          $content = Get-Content $path
          
          # Check if the line exists before trying to change it
          if (-not ($content -match "^AppVersion=")) {
              Write-Error "Ugh, I couldn't find 'AppVersion=' in $path. Can you check it for me babe? ðŸŽ€"
              exit 1
          }

          # Perform the replacement and force UTF8
          $content -replace "^AppVersion=.*", "AppVersion=$tag" | 
            Set-Content $path -Encoding UTF8
          
          Write-Host "Successfully updated AppVersion to $tag in $path ðŸ’–"

      # ---------------------------
      # Setup .NET SDK 10.0
      # ---------------------------
      - name: Setup .NET SDK 10.0.101 # SDK uses a different patch version than runtimes
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.101"

      # ---------------------------
      # Build & validate app
      # ---------------------------
      - name: Restore dependencies
        working-directory: ./client
        run: dotnet restore

      - name: Publish app (Release)
        working-directory: ./client
        run: dotnet publish -c Release

      # ---------------------------
      # Build installer
      # ---------------------------
      - name: Build installer with Inno Setup
        working-directory: ./installer
        shell: cmd
        run: |
          iscc Installer.iss

      # ---------------------------
      # Generate SHA-256
      # ---------------------------
      - name: Generate SHA-256 hash
        working-directory: ./installer
        shell: pwsh
        run: |
          $installer = Get-ChildItem Installer*.exe | Select-Object -First 1
          if (-not $installer) {
            Write-Error "Installer executable not found. Mind checking what happened babe? ðŸŽ€"
            exit 1
          }

          $hash = Get-FileHash $installer.FullName -Algorithm SHA256 |
            Select-Object -ExpandProperty Hash

          Set-Content -Encoding ASCII -Path Installer.exe.sha256 -Value $hash

      # ---------------------------
      # Sign and attest the installer with Cosign
      # ---------------------------
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.3.0

      - name: Sign the installer (Blob)
        run: |
          cosign sign-blob ./installer/Installer.exe `
            --bundle ./installer/Installer.exe.cosign.bundle `
            --yes `
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------------------------
      # Sign and attest the installer with GitHub Attestation
      # ---------------------------
      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: 'installer/Installer.exe'

      # ---------------------------
      # Create GitHub Release
      # ---------------------------
      - name: Create GitHub Release and upload artifacts
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          name: ${{ github.event.inputs.release_name || github.event.inputs.tag_name }}
          prerelease: ${{ github.event.inputs.prerelease }}
          # Add the custom message at the top
          body: |
            ${{ github.event.inputs.custom_notes }}
            
            ---
          generate_release_notes: true # This appends the "What's Changed" section below the body
          files: |
            installer/Installer*.exe
            installer/Installer.exe.sha256
            installer/Installer.exe.cosign.bundle
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
